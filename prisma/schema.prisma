// prisma/schema.prisma
// Version: 3.1.0 - 2025-12-30
// UPDATED: Changed to single 200 DPI architecture (renderZipUrl is PRIMARY, lowRes/highRes are DEPRECATED)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                   String    @id @default(cuid())
  clerkId              String    @unique
  email                String?
  state                String?
  onboarded            Boolean   @default(false)
  quota                Int       @default(5)
  credits              Int       @default(1)
  stripeCustomerId     String?
  stripeSubscriptionId String?
  priceId              String?
  currentPeriodEnd     DateTime?

  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  usage                UserUsage?
  parses               Parse[]

  @@map("users")
}

model UserUsage {
  id         String   @id @default(cuid())
  userId     String   @unique
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  parses     Int      @default(0)
  lastParse  DateTime?

  @@map("user_usage")
}

model Parse {
  id                   String    @id @default(cuid())
  userId               String
  user                 User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  fileName             String
  state                String    @default("Unknown")
  
  rawJson              Json      @default("{}")              
  formatted            Json      @default("{}")              
  missingSCOs          Boolean   @default(false)           
  counterInfo          Json?                               

  // ============================================================================
  // STATUS TRACKING
  // ============================================================================
  // Valid values:
  // - "PENDING" → Ready for render
  // - "PROCESSING" → Currently rendering/classifying/extracting
  // - "NEEDS_REVIEW" → Extraction complete, low confidence
  // - "COMPLETED" → Extraction complete, high confidence
  // - "RENDER_FAILED" → Rendering crashed
  // - "CLASSIFICATION_FAILED" → Classification crashed
  // - "EXTRACTION_FAILED" → Extraction crashed
  status               String    @default("PENDING")

  // ============================================================================
  // TEMPORARY STORAGE (deleted after cleanup)
  // ============================================================================
  // Original PDF buffer - deleted after render completes
  pdfBuffer            Bytes?
  
  // PRIMARY: Single 200 DPI ZIP - Used for BOTH classification AND extraction
  // Deleted after cleanup route runs
  renderZipUrl         String?
  renderZipKey         String?   // Vercel Blob key for deletion
  
  // DEPRECATED: Legacy dual-DPI fields (kept for backward compatibility)
  // New parses should have these as NULL
  lowResZipUrl         String?   // DEPRECATED: Was 180 DPI for classification
  lowResZipKey         String?   // DEPRECATED: Vercel Blob key for deletion
  highResZipUrl        String?   // DEPRECATED: Was 300 DPI for extraction
  highResZipKey        String?   // DEPRECATED: Vercel Blob key for deletion

  // ============================================================================
  // CLASSIFICATION & PAGE INFO
  // ============================================================================
  criticalPageNumbers  Int[]     @default([])   // Pages used for extraction
  pageCount            Int?                     // Total pages in PDF
  
  // TEMPORARY: Classification results (deleted after extraction)
  classificationCache  Json?     // { criticalImages, packageMetadata } - deleted after extract

  // ============================================================================
  // UNIVERSAL CORE FIELDS (top-level for fast queries)
  // ============================================================================
  buyerNames           String[]  @default([])
  sellerNames          String[]  @default([])
  propertyAddress      String?
  purchasePrice        Float?
  earnestMoneyAmount   Float?                   // Deprecated - use earnestMoneyDeposit
  earnestMoneyHolder   String?                  // Deprecated - use earnestMoneyDeposit
  closingDate          String?                  // YYYY-MM-DD or "N days"
  effectiveDate        String?                  // YYYY-MM-DD (final acceptance / acceptance date)
  initialDepositDueDate String?                 // YYYY-MM-DD or "N days" (same as earnest money due date)
  sellerDeliveryOfDisclosuresDate String?       // YYYY-MM-DD or "N days"
  isAllCash            Boolean?
  loanType             String?

  // ============================================================================
  // NESTED UNIVERSAL FIELDS (stored as JSON for rich data)
  // ============================================================================
  earnestMoneyDeposit  Json?     // { amount: number, holder: string }
  financing            Json?     // { isAllCash: boolean, loanType: string, loanAmount: number }
  contingencies        Json?     // { inspectionDays, appraisalDays, loanDays, saleOfBuyerProperty }
  closingCosts         Json?     // { buyerPays: [], sellerPays: [], sellerCreditAmount }
  brokers              Json?     // { listingAgent: { name, company, phone, email }, buyersAgent: { name, company, phone, email } }
  personalPropertyIncluded String[] @default([])
  escrowHolder         String?

  // ============================================================================
  // STATE-SPECIFIC RICHNESS & TIMELINE
  // ============================================================================
  extractionDetails    Json?     // { route: "california"|"universal", californiaSpecific: {...} }
  timelineEvents       Json?     // [{ date, title, type, description }]

  // ============================================================================
  // ERROR TRACKING
  // ============================================================================
  errorMessage         String?   // Error details if status = *_FAILED

  // ============================================================================
  // TIMESTAMPS
  // ============================================================================
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt
  finalizedAt          DateTime? // When extraction completed

  @@index([userId, createdAt])
  @@map("parses")
}