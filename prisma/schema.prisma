// prisma/schema.prisma
// Version: 3.2.0 - 2026-01-26
// UPDATED: Added Gmail integration (GmailSettings, SentEmail) for Comms Center

generator client {
provider = "prisma-client-js"
}

datasource db {
provider = "postgresql"
url      = env("DATABASE_URL")
}

model User {
id                   String    @id @default(cuid())
clerkId              String    @unique
email                String?
name                 String?
phone                String?
state                String?
role                 String?   // office admin, solo agent, team agent, team leader, broker/CEO, other
problems             String[]  @default([]) // contract terms extraction, team workflows, task management, timeline management, other
referralSource       String?   // Google, X, Facebook, Instagram, referral, other
onboarded            Boolean   @default(false)

// Progressive Onboarding Tracking
onboardingDismissedCount Int    @default(0)      // Number of times user clicked "not now"
onboardingOptedOut       Boolean @default(false) // User clicked "don't ask again"
lastOnboardingPrompt     DateTime?               // Last time we showed the modal

// Plan & Subscription (Repurposed for Whop)
planType             String    @default("FREE") // "FREE" | "BASIC"
quota                Int       @default(1)      // Concurrent active transactions (1 for FREE, 5 for BASIC)
credits              Int       @default(1)      // AI parse credits (1 for FREE, resets monthly for BASIC)
stripeCustomerId     String?                    // Repurposed: Whop membership ID
stripeSubscriptionId String?                    // Repurposed: Whop product ID
priceId              String?                    // Repurposed: Whop plan variant (monthly/annual)
currentPeriodEnd     DateTime?                  // Subscription period end

// Usage Tracking
customTaskCount      Int       @default(0)      // Current custom tasks (max 10 for FREE, 100 for BASIC)
templateCount        Int       @default(0)      // Current task templates (max 1 for FREE, 10 for BASIC)
parseLimit           Int       @default(1)      // Monthly parse limit (1 for FREE, 5 for BASIC)
parseCount           Int       @default(0)      // Current month's parse count
parseResetDate       DateTime? @default(now())  // When to reset parseCount to 0

createdAt            DateTime  @default(now())
updatedAt            DateTime  @updatedAt

usage                UserUsage?
parses               Parse[]
tasks                Task[]
taskTemplates        UserTaskTemplate[]
calendarSettings     CalendarSettings?
calendarEvents       CalendarEvent[]
teamMembers          TeamMember[]
communications       Communication[]
gmailSettings        GmailSettings?
sentEmails           SentEmail[]

@@map("users")
}

model UserUsage {
id         String   @id @default(cuid())
userId     String   @unique
user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
parses     Int      @default(0)
lastParse  DateTime?

@@map("user_usage")
}

model Parse {
id                    String    @id @default(cuid())
userId                String
user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)

// Team Support
teamId                String?
team                  Team?     @relation(fields: [teamId], references: [id], onDelete: Cascade)

fileName              String
state                 String    @default("Unknown")

rawJson               Json      @default("{}")

formatted             Json      @default("{}")

missingSCOs           Boolean   @default(false)

counterInfo           Json?

status                String    @default("PENDING")
archived              Boolean   @default(false)

pdfBuffer             Bytes?
pdfPublicUrl          String?

renderZipUrl          String?
renderZipKey          String?

lowResZipUrl          String?

lowResZipKey          String?

highResZipUrl         String?

highResZipKey         String?

criticalPageNumbers   Int[]     @default([])

pageCount             Int?

classificationCache   Json?

transactionType       String?   @default("escrow")
buyerNames            String[]  @default([])
sellerNames           String[]  @default([])
propertyAddress       String?
purchasePrice         Float?
earnestMoneyAmount    Float?

earnestMoneyHolder    String?

closingDate           String?

effectiveDate         String?

initialDepositDueDate String?

sellerDeliveryOfDisclosuresDate String?

isAllCash             Boolean?
loanType              String?

earnestMoneyDeposit   Json?

financing             Json?

contingencies         Json?

closingCosts          Json?

brokers               Json?

personalPropertyIncluded String[] @default([])
escrowHolder          String?

extractionDetails     Json?

timelineEvents        Json?

timelineDataStructured Json?

errorMessage          String?

createdAt             DateTime  @default(now())
updatedAt             DateTime  @updatedAt
finalizedAt           DateTime?

tasks                 Task[]
communications        Communication[]
sentEmails            SentEmail[]

@@index([userId, createdAt])
@@map("parses")
}

model Task {
id                    String    @id @default(cuid())
userId                String
user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
parseId               String?

parse                 Parse?    @relation(fields: [parseId], references: [id], onDelete: Cascade)

teamId                String?
team                  Team?     @relation(fields: [teamId], references: [id], onDelete: Cascade)

assignedToId          String?

assignedTo            TeamMember? @relation("TaskAssignee", fields: [assignedToId], references: [id], onDelete: SetNull)
assignedToRole        String?

taskTypes             String[]

timelineEventId       String?

timelineEventKey      String?

title                 String
description           String?
propertyAddress       String?

amount                Float?

dueDate               DateTime
dueDateType           String    @default("specific")
dueDateValue          Int?

status                String    @default("not_started")
sortOrder             Int       @default(0)

columnId              String    @default("not_started")
archived              Boolean   @default(false)

isCustom              Boolean   @default(false)
isAiGenerated         Boolean   @default(false)
templateId            String?

googleCalendarEventId String?  @unique
syncedToCalendar      Boolean   @default(false)
lastSyncedAt          DateTime?

createdAt             DateTime  @default(now())
updatedAt             DateTime  @updatedAt
completedAt           DateTime?

@@index([userId, parseId])
@@index([userId, status])
@@index([userId, dueDate])
@@index([googleCalendarEventId])
@@map("tasks")
}

model UserTaskTemplate {
id                      String    @id @default(cuid())
userId                  String
user                    User      @relation(fields: [userId], references: [id], onDelete: Cascade)
teamId                  String?
team                    Team?     @relation(fields: [teamId], references: [id], onDelete: Cascade)

name                    String

description             String?

fileType                String    @default("escrow")
isDefaultForNewFiles    Boolean   @default(false)
isAiGenerated           Boolean   @default(false)

tasks                   Json      @default("[]")

createdAt               DateTime  @default(now())
updatedAt               DateTime  @updatedAt

@@index([userId])
@@map("user_task_templates")
}

model CalendarSettings {
id                      String    @id @default(cuid())
userId                  String    @unique
user                    User      @relation(fields: [userId], references: [id], onDelete: Cascade)

googleAccessToken       String?

googleRefreshToken      String?

googleTokenExpiry       DateTime?

primaryCalendarId       String?

archivedCalendarId      String?

syncEnabled             Boolean   @default(true)

includeFullDetails      Boolean   @default(true)

syncNonAppEvents        Boolean   @default(true)

excludeFinancialData    Boolean   @default(true)

webhookChannelId        String?

webhookResourceId       String?

webhookExpiration       DateTime?

// --- START MEMORY FIELDS ---
nextSyncToken           String?   // Bookmark for Google incremental changes
lastSyncStatus          String?   // SUCCESS | ERROR
lastSyncError           String?   // Stores details of failures
lastSyncedAt            DateTime? // Timestamp of last success
// --- END MEMORY FIELDS ---

initialSyncCompleted    Boolean   @default(false)

disconnectedAt          DateTime? // Timestamp when user disconnected calendar (for 30-day deletion cron)

createdAt               DateTime  @default(now())
updatedAt               DateTime  @updatedAt

@@map("calendar_settings")
}

model CalendarEvent {
id                      String    @id @default(cuid())
userId                  String
user                    User      @relation(fields: [userId], references: [id], onDelete: Cascade)

googleEventId           String    @unique
calendarId              String

title                   String
description             String?
start                   DateTime
end                     DateTime
allDay                  Boolean   @default(false)

isAppEvent              Boolean   @default(false)
matchedPropertyAddress  String?

inferredTaskTypes       String[]  @default([])

lastSyncedAt            DateTime  @default(now())

createdAt               DateTime  @default(now())
updatedAt               DateTime  @updatedAt

@@index([userId, isAppEvent])
@@index([userId, start])
@@index([googleEventId])
@@map("calendar_events")
}

model Team {
id                   String    @id @default(cuid())
name                 String
clerkOrgId           String?   @unique

planType             String    @default("TEAMS")
maxMembers           Int       @default(5)

quota                Int       @default(10)

credits              Int       @default(10)

parseLimit           Int       @default(10)

parseCount           Int       @default(0)

parseResetDate       DateTime? @default(now())

stripeCustomerId     String?

stripeSubscriptionId String?

priceId              String?

currentPeriodEnd     DateTime?

createdAt            DateTime  @default(now())
updatedAt            DateTime  @updatedAt

members              TeamMember[]
parses               Parse[]
tasks                Task[]
templates            UserTaskTemplate[]

@@index([clerkOrgId])
@@map("teams")
}

model TeamMember {
id                   String    @id @default(cuid())
teamId               String
team                 Team      @relation(fields: [teamId], references: [id], onDelete: Cascade)

userId               String
user                 User      @relation(fields: [userId], references: [id], onDelete: Cascade)

clerkUserId          String

role                 String

email                String
name                 String?

joinedAt             DateTime  @default(now())

assignedTasks        Task[]    @relation("TaskAssignee")

@@unique([teamId, userId])
@@index([teamId])
@@index([userId])
@@index([clerkUserId])
@@map("team_members")
}

model Communication {
id                   String    @id @default(cuid())
userId               String
user                 User      @relation(fields: [userId], references: [id], onDelete: Cascade)

direction            String    // "inbound" | "outbound"
type                 String    @default("email") // "email" | "sms" (future)

from                 String
to                   String
subject              String?

bodyText             String?   @db.Text
bodyHtml             String?   @db.Text

attachments          Json?     // Array of attachment metadata

status               String    @default("pending") // "pending" | "validated" | "rejected" | "processing" | "completed" | "failed"

rejectionReason      String?
errorMessage         String?

parseId              String?
parse                Parse?    @relation(fields: [parseId], references: [id], onDelete: SetNull)

metadata             Json?     // Email-specific metadata (headers, etc.)

createdAt            DateTime  @default(now())
updatedAt            DateTime  @updatedAt

@@index([userId, createdAt])
@@index([userId, status])
@@index([direction, createdAt])
@@map("communications")
}

// ============================================
// GMAIL INTEGRATION (Comms Center)
// ============================================

model GmailSettings {
id                      String    @id @default(cuid())
userId                  String    @unique
user                    User      @relation(fields: [userId], references: [id], onDelete: Cascade)

// OAuth Tokens (encrypted at application level)
googleAccessToken       String?   @db.Text
googleRefreshToken      String?   @db.Text
googleTokenExpiry       DateTime?

// Gmail-specific settings
primaryEmailAddress     String?   // User's Gmail address
tcHelperLabelId         String?   // ID of the "TC Helper" label in Gmail

// Push Notification Webhook (for real-time email updates)
webhookHistoryId        String?   // Gmail's history ID for incremental sync
webhookExpiration       DateTime?

// Custom Signature
useCustomSignature      Boolean   @default(false)
customSignature         String?   @db.Text  // HTML signature to append

// Sync State
lastSyncStatus          String?   // SUCCESS | ERROR
lastSyncError           String?
lastSyncedAt            DateTime?

// Disconnection tracking
disconnectedAt          DateTime?

createdAt               DateTime  @default(now())
updatedAt               DateTime  @updatedAt

@@map("gmail_settings")
}

model SentEmail {
id                   String    @id @default(cuid())
userId               String
user                 User      @relation(fields: [userId], references: [id], onDelete: Cascade)

// Gmail Message Info
gmailMessageId       String?   // Gmail's message ID
gmailThreadId        String?   // Gmail's thread ID

// Email Content
to                   String[]  // Recipients
cc                   String[]  @default([])
bcc                  String[]  @default([])
subject              String
bodyText             String?   @db.Text
bodyHtml             String?   @db.Text

// Attachments metadata (not stored, just names/sizes for audit)
attachmentsMeta      Json?     // Array of { name, size, mimeType }

// Linking
parseId              String?   // Link to a transaction if applicable
parse                Parse?    @relation(fields: [parseId], references: [id], onDelete: SetNull)

// Audit Trail
sentAt               DateTime  @default(now())
sentVia              String    @default("gmail") // "gmail" | "resend" (for system emails)
ipAddress            String?   // For audit
userAgent            String?   // For audit

createdAt            DateTime  @default(now())

@@index([userId, sentAt])
@@index([gmailThreadId])
@@map("sent_emails")
}