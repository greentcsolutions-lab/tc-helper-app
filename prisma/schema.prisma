generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                   String    @id @default(cuid())
  clerkId              String    @unique
  email                String?
  state                String?
  onboarded            Boolean   @default(false)
  quota                Int       @default(5)
  credits              Int       @default(1)
  stripeCustomerId     String?
  stripeSubscriptionId String?
  priceId              String?
  currentPeriodEnd     DateTime?

  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  usage                UserUsage?
  parses               Parse[]

  @@map("users")
}

model UserUsage {
  id         String   @id @default(cuid())
  userId     String   @unique
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  parses     Int      @default(0)
  lastParse  DateTime?

  @@map("user_usage")
}

model Parse {
  id                   String    @id @default(cuid())
  userId               String
  user                 User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  fileName             String
  state                String    @default("Unknown")
  
  rawJson              Json      @default("{}")              
  formatted            Json      @default("{}")              
  missingSCOs          Boolean   @default(false)           
  counterInfo          Json?                               

  // Status tracking
  status               String    @default("PROCESSING")  // PROCESSING → RENDERED → COMPLETED/NEEDS_REVIEW/EXTRACTION_FAILED

  // PHASE 1: Dual-DPI storage
  lowResZipUrl         String?   
  lowResZipKey         String?   
  
  highResZipUrl        String?   
  highResZipKey        String?   
  
  // DEPRECATED: Legacy fields (keep for backward compatibility)
  pdfBuffer            Bytes?    
  renderZipUrl         String?   
  renderZipKey         String?   

  // Classification & page info
  criticalPageNumbers  Int[]     @default([])   
  pageCount            Int?      

  // === UNIVERSAL CORE FIELDS (top-level for fast queries) ===
  buyerNames           String[]  @default([])
  sellerNames          String[]  @default([])
  propertyAddress      String?
  purchasePrice        Float?
  earnestMoneyAmount   Float?
  earnestMoneyHolder   String?
  closingDate          String?    // YYYY-MM-DD
  effectiveDate        String?    // YYYY-MM-DD (final acceptance)
  isAllCash            Boolean?
  loanType             String?

  // === STATE-SPECIFIC RICHNESS ===
  extractionDetails    Json?      // { route: "california", californiaSpecific: {...}, ... }
  timelineEvents       Json?      // Array of { date, title, type, description? }

  // Error tracking
  errorMessage         String?                             

  // Timestamps
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt
  finalizedAt          DateTime?                           

  @@index([userId, createdAt])
  @@map("parses")
}